<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente Visual</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    video {
      border: 2px solid #fff;
      border-radius: 10px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #1e90ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    textarea {
      margin-top: 10px;
      width: 90%;
      height: 60px;
      border-radius: 5px;
      border: 1px solid #555;
      padding: 10px;
      font-size: 16px;
      background-color: #222;
      color: white;
    }
    p {
      margin-top: 10px;
      font-size: 18px;
    }
    strong {
      color: #1e90ff;
    }
  </style>
</head>
<body>
  <h2>üé• Asistente Visual</h2>

  <video id="video" autoplay width="300"></video><br><br>
  <button id="capturar">üéôÔ∏è Hablar y Capturar</button><br><br>

  <textarea id="pregunta" placeholder="Tu pregunta aparecer√° aqu√≠..."></textarea><br><br>

  <p><strong>Estado:</strong> <span id="estado">Esperando...</span></p>
  <p><strong>Respuesta:</strong> <span id="respuesta"></span></p>

  <script>
    const video = document.getElementById("video");
    const canvas = document.createElement("canvas");
    const preguntaInput = document.getElementById("pregunta");
    const estado = document.getElementById("estado");
    const respuestaOutput = document.getElementById("respuesta");

    // Detectar si es un dispositivo m√≥vil
    const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const constraints = esMovil
      ? { video: { facingMode: { exact: "environment" } } }
      : { video: true };

    // Activar c√°mara
    navigator.mediaDevices.getUserMedia(constraints)
      .then(stream => {
        video.srcObject = stream;
        estado.innerText = "‚úÖ C√°mara activada";
        console.log("‚úÖ C√°mara activada con:", constraints);
      })
      .catch(err => {
        estado.innerText = "‚ùå Error al acceder a la c√°mara: " + err.message;
        console.error("‚ùå Error c√°mara:", err);
      });

    const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recog.lang = "es-ES";

    recog.onstart = () => {
      estado.innerText = "üéôÔ∏è Escuchando...";
      console.log("üéôÔ∏è Reconocimiento iniciado");
    };

    recog.onresult = e => {
      const texto = e.results[0][0].transcript;
      preguntaInput.value = texto;
      estado.innerText = "‚úÖ Pregunta capturada: " + texto;
      console.log("‚úÖ Pregunta transcrita:", texto);

      // Capturar imagen despu√©s de la transcripci√≥n
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      canvas.toBlob(blob => {
        if (!blob) {
          estado.innerText = "‚ùå No se pudo capturar la imagen";
          return;
        }

        console.log("üì§ Preparando env√≠o a Flask...");
        estado.innerText = "üì§ Enviando imagen y pregunta...";

        const formData = new FormData();
        formData.append("imagen", blob, "foto.jpg");
        formData.append("pregunta", texto);

        fetch("http://192.168.1.161:5000/analizar", {
          method: "POST",
          body: formData
        })
        .then(res => {
          if (!res.ok) throw new Error("Respuesta no OK del servidor");
          return res.json();
        })
        .then(data => {
          console.log("‚úÖ Respuesta recibida:", data);
          const respuesta = data.respuesta || data.mensaje || "Respuesta no definida";
          estado.innerText = "‚úÖ Respuesta recibida";
          respuestaOutput.innerText = respuesta;

          try {
            const decir = new SpeechSynthesisUtterance(respuesta);
            decir.lang = "es-ES";
            speechSynthesis.speak(decir);
          } catch (vozError) {
            console.error("‚ùå Error al hablar:", vozError);
          }
        })
        .catch(err => {
          estado.innerText = "‚ùå Error en la respuesta";
          console.error("‚ùå Error en fetch o procesamiento:", err);
        });
      }, "image/jpeg");
    };

    recog.onerror = e => {
      estado.innerText = "‚ùå Error de reconocimiento: " + e.error;
      console.error("‚ùå Error reconocimiento de voz:", e);
    };

    document.getElementById("capturar").onclick = () => {
      recog.start();
    };
  </script>
</body>
</html>
